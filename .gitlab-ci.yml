
image: magento/magento-cloud-docker-php:8.1-cli-1.3.4

cache:
  paths:
    - .magento

before_script:
  - mkdir -p .magento
  - cd .magento
  - rm -rf app/code/Smile/Onestock
  - stat composer.json || composer create-project --repository-url=https://repo.magento.com/ magento/project-community-edition .
  - composer require --dev smile/magento2-smilelab-quality-suite
  - mkdir -p app/code/Smile/Onestock
  - mv ../* app/code/Smile/Onestock
  - apt-get update -qq && apt-get install -y -qq xsltproc

phpcs:
  stage: test
  script:
    - vendor/bin/phpcs --report=junit --report-file=../phpcs.xml --standard=SmileLab app/code/Smile/Onestock/
  tags:
    - galaxy-docker-shared
  artifacts:
    reports:
      junit:
        - phpcs.xml

phpunit:
  stage: test
  script:
    - vendor/bin/phpunit --log-junit ../phpunit.xml app/code/Smile/Onestock/
  tags:
    - galaxy-docker-shared
  artifacts:
    reports:
      junit:
        - phpunit.xml

phpstan:
  stage: test
  script:
    - vendor/bin/phpstan analyse app/code/Smile/Onestock/ --error-format=junit --no-progress > ../phpstan.xml
  tags:
    - galaxy-docker-shared
  artifacts:
    reports:
      junit:
        - phpstan.xml

phpmd:
  stage: test
  script:
    - vendor/bin/phpmd  app/code/Smile/Onestock/ xml vendor/smile/magento2-smilelab-phpmd/ruleset.xml | xsltproc ../.phpunit.xslt - > ../phpmd.xml
  tags:
    - galaxy-docker-shared
  artifacts:
    reports:
      junit:
        - phpmd.xml
